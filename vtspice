#!/bin/bash

#####################################################################################################
#
#	vtspice - Running SPICE simulations on remote servers 
#
#	Author:		nxg-nxg
#	Repository:	https://github.com/nxg-nxg/vtspice.git
#	Date:		2022/11/18
#
#####################################################################################################

## 			DEPENDENCY
## - hspice (You can change to other SPICE like ngspice)
## - screen
## - ssh,scp
##
##
## 			BEFORE USING
## This script transfers local files to a remote server via scp 
## and runs the simulation on the remote server with screen 
## virtual terminal. Depending on your machine configuration, 
## you may need to enter a password for the ssh connection. 
## If this is inconvenient, it is recommended to create a 
## special user on remote server who can only execute SPICE 
## commands and use public key authentication without a password.
##
##
## 			VARIABLES
## Username who run simulation on remote server
REMOTEUSR="user1"

## IP adress of remote server
REMOTEIP="192.168.0.100"

## Path of directory for vtspice on remote server (Do not include the / at the end)
REMOTEVTSDIR="/home/remoteuser/vtspice"

## Path to the original file of the SPICE command (Use `which hspice`)
SPICE="/path/to/hspice"

## Options given to SPICE commands
OPTIONS="-mt 8 -hpp"


#####################################################################################################

## INPUT CHECK
if [ $# == 0 ] || [ $1 == "--help" ] || [ $1 == "-help" ] || [ $1 == "-h" ]
then
        echo "EXAMPLE: vtspice INV.sp INV.inp netlist mos.mdl mos.skw..."
        echo "USAGE  : vtspice <.sp file> <other files>"
		echo "TIPS   : Putting model files on remote server reduces the num of args"
        exit 0
fi


## REQUEST SIMULATION TO REMOTE SERVER
if [ $1 != "run" ]
then 
	HEADFILE=$1
	OTHERFILES=${@:2}
	RUNDATE=`date "+%m%d%H%M%S"`

	# FILES (INCLUDE THIS SCRIPT) IS SENT TO REMOTE SERVER
	mkdir ${RUNDATE}
	cp $0 ${HEADFILE} ${OTHERFILES} ${RUNDATE}/
	if [ $? != 0 ]
	then 
		echo "ERROR: No such file."
		rm -rf ${RUNDATE}
		exit 0
	fi

	scp -r ${RUNDATE} ${REMOTEUSR}@${REMOTEIP}:${REMOTEVTSDIR}
	if [ $? != 0 ]
	then 
		echo "ERROR: scp command failed."
		rm -rf ${RUNDATE}
		exit 0
	fi
	rm -rf ${RUNDATE}

	# RUN vtspice SCRIPT WITH VIRTUAL TERMINAL
	ssh -t ${REMOTEUSR}@${REMOTEIP} screen "sh -c \"cd ${REMOTEVTSDIR}/${RUNDATE}; ./vtspice run ${HEADFILE} ${OTHERFILES} ${RUNDATE}\""

	# COPY RESULT FILES ON REMOTE SERVER TO LOCAL SERVER
	scp -r ${REMOTEUSR}@${REMOTEIP}:${REMOTEVTSDIR}/${RUNDATE}/* ./

	# REMOVE RESULT FILES ON REMOTE SERVER
	ssh ${REMOTEUSR}@${REMOTEIP} rm -rf ${REMOTEVTSDIR}/${RUNDATE}
	
	echo "FINISHED: vtspice finished successfully!"
fi


## RUN SIMULATION ON REMOTE SERVER
if [ $1 == "run" ]
then 
	HEADFILE=$2
	OTHERFILES=$3
	RUNDATE=$4
	CELLNAME=${HEADFILE%.*}
	
	# START SIMULATION
	"${SPICE}" ${HEADFILE} ${OPTIONS} | tee ${CELLNAME}.spice.log

	# REMOVE FILES WHICH SENT FROM LOCAL SERVER
	rm ./${HEADFILE} ./${OTHERFILES} $0 -f
fi



